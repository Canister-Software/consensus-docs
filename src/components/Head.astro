---
const siteTitle = 'Consensus Protocol Documentation | x402 Proxy Network';
const defaultDescription =
  'A peer-to-peer x402 proxy network enabling deterministic HTTP and WebSocket execution across independent nodes.';

const canonicalUrl = Astro.url.href;
const ogImage = new URL('/consensus-docs.png', Astro.site).href;
---

<title>{siteTitle}</title>
<meta name="description" content={defaultDescription} />
<link rel="canonical" href={canonicalUrl} />

<!-- Open Graph -->
<meta property="og:type" content="website" />
<meta property="og:url" content={canonicalUrl} />
<meta property="og:title" content={siteTitle} />
<meta property="og:description" content={defaultDescription} />
<meta property="og:image" content={ogImage} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />

<!-- X / Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={canonicalUrl} />
<meta name="twitter:title" content={siteTitle} />
<meta name="twitter:description" content={defaultDescription} />
<meta name="twitter:image" content={ogImage} />

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/favicon-dark.svg" id="os-favicon" />

<script is:inline>
  (() => {
    const darkModeHref = '/favicon.svg';
    const lightModeHref = '/favicon-dark.svg';
    const link = document.querySelector('link#os-favicon');
    if (!link) return;

    const apply = (isDark) => {
      const base = isDark ? darkModeHref : lightModeHref;
      link.setAttribute('href', `${base}?v=${Date.now()}`);
    };

    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    apply(mq.matches);
    mq.addEventListener('change', (e) => apply(e.matches));
  })();
</script>

<script is:inline>
  (() => {
    const selector = '.consensus-diagram';

    const init = () => {
      const existing = document.getElementById('diagram-lightbox');
      const dialog =
        existing ||
        (() => {
          const el = document.createElement('dialog');
          el.id = 'diagram-lightbox';
          el.innerHTML = `
            <div class="diagram-lightbox__frame">
              <img class="diagram-lightbox__img" alt="" />
            </div>
          `;
          (document.body || document.documentElement).appendChild(el);
          return el;
        })();

      const img = dialog.querySelector('.diagram-lightbox__img');
      if (!img) return;

      const close = () => {
        dialog.removeAttribute('data-zoom');
        dialog.removeAttribute('data-zoom-origin');
        img.removeAttribute('src');
        dialog.close();
      };

      dialog.addEventListener('click', (e) => {
        if (e.target === dialog) close();
      });

      dialog.addEventListener('close', () => {
        dialog.removeAttribute('data-zoom');
        dialog.removeAttribute('data-zoom-origin');
        img.removeAttribute('src');
      });

      img.addEventListener('click', (e) => {
        e.stopPropagation();
        dialog.dataset.zoom = dialog.dataset.zoom === 'in' ? '' : 'in';
      });

      document.addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLImageElement)) return;
        if (!target.matches(selector)) return;
        e.preventDefault();
        img.src = target.currentSrc || target.src;
        img.alt = target.alt || '';
        dialog.showModal();
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  })();
</script>
