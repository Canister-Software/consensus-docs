---
const { head } = Astro.locals.starlightRoute;

const osFavicon = {
  tag: 'link',
  attrs: {
    rel: 'icon',
    type: 'image/svg+xml',
    href: '/favicon-dark.svg',
    id: 'os-favicon',
  },
};

const filteredHead = head.filter((entry) => {
  return !(
    entry.tag === 'link' &&
    (entry.attrs?.rel === 'icon' || entry.attrs?.rel === 'shortcut icon')
  );
});

const headWithOsIcon = [...filteredHead, osFavicon];
---

{headWithOsIcon.map(({ tag: Tag, attrs, content }) => (
  <Tag {...attrs} set:html={content} />
))}

<script is:inline>
  (() => {
    const darkModeHref = '/favicon.svg';
    const lightModeHref = '/favicon-dark.svg';

    const link = document.querySelector('link#os-favicon');
    if (!link) return;

    const apply = (isDark) => {
      const base = isDark ? darkModeHref : lightModeHref;
      const next = `${base}?v=${Date.now()}`;
      link.setAttribute('href', next);
    };

    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    apply(mq.matches);

    mq.addEventListener('change', (e) => apply(e.matches));
  })();
</script>
